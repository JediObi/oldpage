### **交易的安全性保障**

讨论安全之前先看交易的创建和广播 

+ 创建和广播

创建的关键在于引用链上的utxo，并签名，而签名需要对整个交易信息签名，所以要先构造字段 

```
(1) 填充字段 比特币协议版本号
// 输入
(2) 填充字段 输入数
(3) 循环构造输入
  --> 填充字段 引用的utxo交易hash值
  --> 填充字段 引用的输出索引
  --> 填充字段 签名脚本，由于交易还没创建完成，所以脚本长度字段 00，表示没签名，则目前这个签名脚本字段为 00
  --> 填充字段 输入的序列号，暂定 ffffffff
(4) 填充字段 输出数
(5) 循环构造输出
  --> 填充字段 交易额
  --> 填充字段 输出脚本
(6) 填充字段 锁定时间

(7) 把当前的交易签名
涉及到 各字段格式转换（字节数组，数组拼接，进制转换16进制）
然后对整个原始交易签名

(8) 把签名结果 和 用户的公钥 填充到 签名脚本

(9) 对当前交易计算hash值产生 交易流水号
(10) 广播
```

+ 安全保障

```
如果一个交易被广播到某个交易池后，被人提取并修改。
如果要盗取比特币，则修改交易输出中的 <pub_key_hash> 字段
这会导致整个交易信息变更。
(1) 交易信息变更，不改变签名和公钥，本机验签失败，交易无效。
不考虑私钥泄露的情形，使用的黑客的密钥对重新签名。
(2) 交易信息变更，签名改为黑客的私钥签名，本机公钥验签失败，交易无效。
(3) 交易信息变更，签名改为黑客的私钥签名，公钥改为黑客的公钥，本机验证公钥不匹配utxo输出，交易无效。
(4) 交易信息变更，公钥改为黑客的公钥，本机验证公钥不匹配utxo输出，交易无效。

(3) 在本机修改底层实现，绕过本机验证，构造交易并广播，再来看上述情形
     1) 交易信息m变更，不改变签名(r,s)和公钥y，其他节点验签失败(v!=r)，交易无效。
     2) 交易信息m变更，签名改为黑客的私钥签名(r',s')，其他节点验签失败(v!=r')，交易无效
     3) 交易信息m变更，签名改为黑客的私钥签名(r',s')，公钥改为黑客的公钥y'，其他节点验证公钥不匹配utxo输出(y'_hash!=y_hash)，交易无效。
     4) 交易信息m变更，公钥改为黑客的公钥y'，其他节点验证公钥不匹配utxo输出(y'_hash!=y_hash)，交易无效。
```