### **交易的数据结构和验证流程**



## 数据结构

+ #### 交易

(1) 版本号 4字节 
(2) 输入数量 1-9字节 
(3) 输入列表 长度不定 
(4) 输出数量 1-9字节 
(5) 输出列表 长度不定 
(6) 锁定时间 4字节 

+ #### 输入
(1) utxo所在交易哈希 32字节 
(2) 输出索引 4字节 
(3) 签名脚本（解锁脚本）的长度  1-9字节 
(4) 签名脚本 长度不定 
(5) 序列号 4字节，暂时无用，所以使用 ffffffff 

+ #### 输出

(1) 交易额 8字节 
(2) 锁定脚本的长度 1-9字节 
(3) 锁定脚本 

+ #### 签名脚本（解锁脚本）

已知解锁脚本包含 私钥签名和公钥 
但还包含一些说明信息，因编码而异（有的教程中锁定脚本附带栈操作符）。 
一个不带操作符的签名脚本格式 

```
30 [45 02 21 r 02 20 s 01] [21 pub_key]

30 是脚本开始 0x30
// 签名
45 是签名的长度 0x45 = 69字节
02 一个分隔符 0x02
21 r的长度 0x21=33字节
r    
02 一个分隔符
20 s的长度 0x20=32字节
s
01 签名类型，三种签名类型，默认0x01全都签名
// 公钥
21 公钥长度 1字节
pub_key 公钥，当前用户的公钥
```

+ #### 锁定脚本

P2PKH 

```
OP_DUP OP_HASH160 <pub_key_hash> OP_EQUALVERIFY OP_CHECKSIG

//
<pub_key_hash> 是收款人的钱包地址（公钥hash值）
```

交易验证流程 

```js
签名脚本入栈
<sig> <pub_key>
锁定脚本入栈执行
OP_DUP
<sig> <pub_key> <pub_key> 

OP_HASH160
<sig> <pub_key> <pub_key_hash'> 

<pub_key_hash>
<sig> <pub_key> <pub_key_hash'> <pub_key_hash>

OP_EQUALVERIFY
<sig> <pub_key>

OP_CHECKSIG
// v=r，已知p,q,g，公钥y、r、s，证明v=r
```


